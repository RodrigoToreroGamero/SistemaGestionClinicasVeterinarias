<!DOCTYPE html>
<html layout:decorate="_layoutVeterinario">
<head>
    <title>Pacientes - Veterinario</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h2 class="mb-4">Consulta de Pacientes</h2>
        <!-- Selección de mascota -->
        <div class="card mb-4">
            <div class="card-header">Selecciona una Mascota</div>
            <div class="card-body">
                <select class="form-select" id="select-mascota">
                    <option value="">Selecciona una mascota</option>
                    <!-- Opciones dinámicas -->
                </select>
            </div>
        </div>
        <!-- Formulario de datos de la mascota (solo lectura) -->
        <div class="card mb-4" id="card-datos-mascota" style="display:none;">
            <div class="card-header">Datos de la Mascota</div>
            <div class="card-body">
                <form class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Especie</label>
                        <input type="text" class="form-control" id="especie" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Raza</label>
                        <input type="text" class="form-control" id="raza" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Edad</label>
                        <input type="number" class="form-control" id="edad" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Dueño</label>
                        <input type="text" class="form-control" id="dueno" readonly>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>

    const cardDatosMascota = document.getElementById('card-datos-mascota');
    const inputNombre = document.getElementById('nombre');
    const inputEspecie = document.getElementById('especie');
    const inputRaza = document.getElementById('raza');
    const inputEdad = document.getElementById('edad');
    const inputDueno = document.getElementById('dueno');
    
    // Cargar mascotas al iniciar
    async function cargarMascotas() {
        const resp = await fetch('/api/Mascota');
        if (!resp.ok) {
            selectMascota.innerHTML = '<option value="">No se pudieron cargar las mascotas</option>';
            return;
        }
        const mascotas = await resp.json();
        selectMascota.innerHTML = '<option value="">Selecciona una mascota</option>';
        mascotas.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.nombre + ' (ID: ' + m.id + ')';
            option.dataset.idDueno = m.id_dueno;
            selectMascota.appendChild(option);
        });
    }
    
    // Mostrar datos de la mascota seleccionada
    async function mostrarDatosMascota(mascotaId) {
        if (!mascotaId) {
            cardDatosMascota.style.display = 'none';
            return;
        }
        // Buscar la mascota seleccionada
        const resp = await fetch('/api/Mascota');
        if (!resp.ok) {
            alert('No se pudo obtener la información de la mascota.');
            return;
        }
        const mascotas = await resp.json();
        const mascota = mascotas.find(m => m.id == mascotaId);
        if (!mascota) {
            cardDatosMascota.style.display = 'none';
            return;
        }
        inputNombre.value = mascota.nombre || '';
        inputEspecie.value = mascota.especie || '';
        inputRaza.value = mascota.raza || '';
        inputEdad.value = mascota.edad || '';
        // Obtener nombre del dueño
        if (mascota.id_dueno) {
            const respDueno = await fetch(`/api/Dueno/${mascota.id_dueno}`);
            if (respDueno.ok) {
                const dueno = await respDueno.json();
                if (dueno && dueno.usuario && dueno.usuario.id) {
                    const respUsuario = await fetch(`/api/Usuario/${dueno.usuario.id}`);
                    if (respUsuario.ok) {
                        const usuario = await respUsuario.json();
                        inputDueno.value = (usuario.nombres || '') + ' ' + (usuario.apellidos || '');
                    } else {
                        inputDueno.value = 'No registrado';
                    }
                } else {
                    inputDueno.value = 'No registrado';
                }
            } else {
                inputDueno.value = 'No registrado';
            }
        } else {
            inputDueno.value = 'No registrado';
        }
        cardDatosMascota.style.display = 'block';
    }
    
    // Evento al seleccionar mascota
    selectMascota.addEventListener('change', function() {
        mostrarDatosMascota(this.value);
    });
    
    // Inicializar
    window.addEventListener('DOMContentLoaded', cargarMascotas);
    </script>
</body>
</html> 