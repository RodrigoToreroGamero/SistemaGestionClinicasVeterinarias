<!DOCTYPE html>
<html   layout:decorate="_layout"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VetGes: Gestion de citas</title>
    </head>
    <body>
        <div layout:fragment="content">
            <h1>Gestion de citas</h1>
            <p class="text-end">
                <button class="btn btn-primary" @click="nuevo">Nuevo</button>
            </p>
            <p>
            </p>
            <table class="table">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Dueño</th>
                        <th>Mascota</th>
                        <th>Veterinario</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in entidades">
                        <td>{{item.id}}</td>
                        <td>{{ getNombreDueno(item.dueno.id) }}</td>
                        <td>{{ getNombreMascota(item.mascota.id) }}</td>
                        <td>{{ getNombreVeterinario(item.veterinario.id) }}</td>
                        <td>{{item.fecha}}</td>
                        <td>{{item.hora}}</td>
                        <td>{{item.estado}}</td>
                        <td class="text-end">
                            <button class="btn btn-primary" @click="editar(item.id)">Editar</button>
                            <button class="btn btn-danger" @click="eliminar(item.id)">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="modal" tabindex="-1" id="mdlEntidad">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" v-if="entidad.id==0">Nueva</h5>
                            <h5 class="modal-title" v-if="entidad.id!=0">Editar</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <div class="form-group row">
                                <label for="nombres" class="col-sm-2 col-form-label">Fecha</label>
                                <div class="col-sm-10">
                                    <input type="date" class="form-control" id="fecha" v-model="entidad.fecha" required/>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="apellidos" class="col-sm-2 col-form-label">Hora</label>
                                <div class="col-sm-10">
                                    <input type="time" class="form-control" id="hora" v-model="entidad.hora" required/>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Dueño</label>
                                <div class="col-sm-10">
                                    <select class="form-control" v-model="entidad.dueno.id" @change="onDuenoChange" required>
                                        <option disabled value="">Seleccione un dueño</option>
                                        <option v-for="dueno in duenos" :value="dueno.id">
                                            {{ dueno.usuario.nombres }} {{ dueno.usuario.apellidos }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Mascota</label>
                                <div class="col-sm-10">
                                    <select class="form-control" v-model="entidad.mascota.id" required>
                                        <option disabled value="">Seleccione una mascota</option>
                                        <option v-for="mascota in mascotasFiltradas" :value="mascota.id">
                                            {{ mascota.nombre }} ({{ mascota.especie }} - {{ mascota.raza }})
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Veterinario</label>
                                <div class="col-sm-10">
                                    <select class="form-control" v-model="entidad.veterinario.id" required>
                                        <option disabled value="">Seleccione un veterinario</option>
                                        <option v-for="Veterinario in veterinarios" :value="Veterinario.id">
                                            {{ Veterinario.usuario.nombres}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" v-if="entidad.id==0" @click="guardar">Guardar</button>
                            <button type="button" class="btn btn-primary" v-if="entidad.id!=0" @click="actualizar">Actualizar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal" tabindex="-1" id="mdlEliminar">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Eliminar</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ¿Estás seguro que quieres eliminar?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" @click="confimareliminacion">Eliminar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script layout:fragment="script">
            new Vue({
                el: "#app",
                data: {
                    entidades: [],
                    entidad: {
                        dueno: {id: null},
                        mascota: {id: null},
                        veterinario: {id: null}
                    },
                    duenos: [],
                    mascotas: [],
                    veterinarios: []
                },
                computed: {
                    mascotasFiltradas: function() {
                        if (!this.entidad.dueno.id) {
                            return [];
                        }
                        return this.mascotas.filter(mascota => mascota.dueno.id === this.entidad.dueno.id);
                    }
                },
                methods: {
                    getNombreDueno: function(id) {
                        const dueno = this.duenos.find(d => d.id === id);
                        return dueno ? (dueno.usuario.nombres + ' ' + dueno.usuario.apellidos) : 'Desconocido';
                    },
                    getNombreMascota: function(id) {
                        const mascota = this.mascotas.find(d => d.id === id);
                        return mascota ? (mascota.nombre + '-' + mascota.especie) : 'Desconocido';
                    },
                    getNombreVeterinario: function(id) {
                        const veterinario = this.veterinarios.find(d => d.id === id);
                        return veterinario ? (veterinario.usuario.nombres + ' ' + veterinario.usuario.apellidos) : 'Desconocido';
                    },
                    listarMascotas: function () {
                        this.$http.get('/api/Mascota')
                            .then(response => {
                                this.mascotas = response.data;
                                console.log('Mascotas:', this.mascotas);
                            })
                            .catch(error => {
                                console.error('Problema al cargar mascotas:', error.response ? error.response.data : error);
                            });
                    },
                    listarDuenos: function () {
                        this.$http.get('/api/Dueno')
                            .then(response => {
                                this.duenos = response.data;
                                console.log('Duenos:', this.duenos);
                            })
                            .catch(error => {
                                console.error('Problema al cargar duenos:', error.response ? error.response.data : error);
                            });
                    },
                    listar: function () {
                        this.$http.get('/api/Cita').then(response => {
                            this.entidades = response.data;
                        });
                    },
                    nuevo: function () {
                        this.entidad = {
                            id: 0,
                            fecha: null,
                            hora: null,
                            mascota: {id: null},
                            veterinario: {id: null},
                            estado: "Pendiente",
                            dueno: { id: null}
                        };
                        $("#mdlEntidad").modal("show");
                    },
                    editar: function (id) {
                        this.$http.get('/api/Cita/' + id).then(response => {
                            this.entidad = response.data;
                            $("#mdlEntidad").modal("show");
                        });
                    },
                    guardar: function () {
                        this.$http.post('/api/Cita', this.entidad).then(response => {
                            this.listar();
                            $("#mdlEntidad").modal("hide");
                        });
                    },
                    actualizar: function () {
                        this.$http.put('/api/Cita/' + this.entidad.id, this.entidad).then(response => {
                            this.listar();
                            $("#mdlEntidad").modal("hide");
                        });
                    },
                    eliminar: function (id) {
                        this.entidad.id = id;
                        $("#mdlEliminar").modal("show");
                    },
                    confimareliminacion: function () {
                        this.$http.delete('/api/Cita/' + this.entidad.id).then(response => {
                            this.listar();
                            $("#mdlEliminar").modal("hide");
                        });
                    },
                    onDuenoChange: function () {
                        // Reset mascota selection when dueno changes
                        this.entidad.mascota.id = null;
                    },
                    listarVeterinarios: function () {
                        this.$http.get('/api/Veterinario')
                            .then(response => {
                                this.veterinarios = response.data;
                                console.log('Veterinarios:', this.veterinarios);
                            })
                            .catch(error => {
                                console.error('Problema al cargar veterinarios:', error.response ? error.response.data : error);
                            });
                    }
                },
                mounted: function () {
                    this.listar();
                    this.listarDuenos();
                    this.listarMascotas();
                    this.listarVeterinarios();
                }
            });
        </script>
    </body>
</html>