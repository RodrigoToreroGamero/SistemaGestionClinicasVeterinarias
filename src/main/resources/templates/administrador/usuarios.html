<html layout:decorate="_layoutAdministrador">
<head>
    <title th:text="${titulo}">Gestión de Usuarios</title>
    <style>
        .usuarios-header {
            background: linear-gradient(90deg, #dc3545 0%, #ff7675 100%);
            color: #fff;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 8px rgba(220,53,69,0.08);
            padding: 1.5rem 1rem 1rem 1rem;
        }
        .usuarios-table th {
            background: #f8f9fa;
            color: #dc3545;
            font-weight: 600;
        }
        .usuarios-table tbody tr:hover {
            background: #fff3f4;
            transition: background 0.2s;
        }
        .badge-fecha {
            background: #ffe0e6;
            color: #dc3545;
            font-size: 0.95em;
        }
        .btn-ver {
            background: #17a2b8;
            color: #fff;
        }
        .btn-ver:hover {
            background: #138496;
            color: #fff;
        }
        .btn-editar {
            background: #ffc107;
            color: #222;
        }
        .btn-editar:hover {
            background: #e0a800;
            color: #222;
        }
        .btn-eliminar {
            background: #dc3545;
            color: #fff;
        }
        .btn-eliminar:hover {
            background: #b71c1c;
            color: #fff;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="usuarios-header mb-3 d-flex align-items-center justify-content-between">
                    <div>
                        <h2 class="mb-0" th:text="${titulo}">Gestión de Usuarios</h2>
                        <p class="lead mb-0">Listado de usuarios registrados en el sistema</p>
                    </div>
                    <div>
                        <i class="icon-users" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <div class="card shadow rounded-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" style="color:#dc3545;">Lista de Usuarios</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table usuarios-table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombres</th>
                                        <th>Apellidos</th>
                                        <th>DNI</th>
                                        <th>Celular</th>
                                        <th>Fecha Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usuariosTbody">
                                    <!-- Se llenará por JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="alertaUsuario" class="alert d-none mt-3" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modales -->
<div class="modal fade" id="modalVerUsuario" tabindex="-1" aria-labelledby="modalVerUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVerUsuarioLabel">Información del Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2"><strong>Nombres:</strong> <span id="verNombres"></span></div>
                <div class="mb-2"><strong>Apellidos:</strong> <span id="verApellidos"></span></div>
                <div class="mb-2"><strong>DNI:</strong> <span id="verDni"></span></div>
                <div class="mb-2"><strong>Celular:</strong> <span id="verCelular"></span></div>
                <div class="mb-2"><strong>Fecha de Nacimiento:</strong> <span id="verFechaNacimiento"></span></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalEditarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarUsuarioLabel">Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarUsuario">
                    <input type="hidden" id="editarId">
                    <div class="mb-3">
                        <label for="editarNombres" class="form-label">Nombres</label>
                        <input type="text" class="form-control" id="editarNombres" required>
                    </div>
                    <div class="mb-3">
                        <label for="editarApellidos" class="form-label">Apellidos</label>
                        <input type="text" class="form-control" id="editarApellidos" required>
                    </div>
                    <div class="mb-3">
                        <label for="editarDni" class="form-label">DNI</label>
                        <input type="text" class="form-control" id="editarDni" required>
                    </div>
                    <div class="mb-3">
                        <label for="editarCelular" class="form-label">Celular</label>
                        <input type="text" class="form-control" id="editarCelular" required>
                    </div>
                    <div class="mb-3">
                        <label for="editarFechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="editarFechaNacimiento">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarCambios">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalEliminarUsuario" tabindex="-1" aria-labelledby="modalEliminarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEliminarUsuarioLabel">Eliminar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este usuario?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>
<script layout:fragment="script">
function mostrarAlerta(mensaje, tipo) {
    const alerta = document.getElementById('alertaUsuario');
    alerta.className = 'alert alert-' + tipo;
    alerta.textContent = mensaje;
    alerta.classList.remove('d-none');
    setTimeout(() => alerta.classList.add('d-none'), 3000);
}
let usuarioAEliminar = null;
let usuariosData = [];
function renderUsuariosTabla() {
    const tbody = document.getElementById('usuariosTbody');
    tbody.innerHTML = '';
    usuariosData.forEach(usuario => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${usuario.id}</td>
            <td>${usuario.nombres || ''}</td>
            <td>${usuario.apellidos || ''}</td>
            <td>${usuario.dni || ''}</td>
            <td>${usuario.celular || ''}</td>
            <td><span class="badge badge-fecha">${usuario.fecha_registro ? (usuario.fecha_registro.length > 10 ? usuario.fecha_registro.substring(0, 10) : usuario.fecha_registro) : ''}</span></td>
            <td>
                <button class="btn btn-ver btn-sm me-1" data-id="${usuario.id}" title="Ver"><i class="icon-eye"></i></button>
                <button class="btn btn-editar btn-sm me-1" data-id="${usuario.id}" title="Editar"><i class="icon-pencil"></i></button>
                <button class="btn btn-eliminar btn-sm" data-id="${usuario.id}" title="Eliminar"><i class="icon-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
function cargarUsuarios() {
    fetch('/api/duenos')
        .then(resp => resp.json())
        .then(data => {
            usuariosData = data;
            renderUsuariosTabla();
        })
        .catch(() => mostrarAlerta('Error al cargar usuarios', 'danger'));
}
document.addEventListener('DOMContentLoaded', function() {
    cargarUsuarios();
    document.getElementById('usuariosTbody').addEventListener('click', function(e) {
        const btnVer = e.target.closest('.btn-ver');
        const btnEditar = e.target.closest('.btn-editar');
        const btnEliminar = e.target.closest('.btn-eliminar');
        if (btnVer) {
            const id = btnVer.getAttribute('data-id');
            const usuario = usuariosData.find(u => u.id == id);
            if (usuario) {
                document.getElementById('verNombres').textContent = usuario.nombres || '';
                document.getElementById('verApellidos').textContent = usuario.apellidos || '';
                document.getElementById('verDni').textContent = usuario.dni || '';
                document.getElementById('verCelular').textContent = usuario.celular || '';
                document.getElementById('verFechaNacimiento').textContent = usuario.fecha_nacimiento ? usuario.fecha_nacimiento.split('T')[0] : '';
                new bootstrap.Modal(document.getElementById('modalVerUsuario')).show();
            }
        }
        if (btnEditar) {
            const id = btnEditar.getAttribute('data-id');
            const usuario = usuariosData.find(u => u.id == id);
            if (usuario) {
                document.getElementById('editarId').value = usuario.id;
                document.getElementById('editarNombres').value = usuario.nombres || '';
                document.getElementById('editarApellidos').value = usuario.apellidos || '';
                document.getElementById('editarDni').value = usuario.dni || '';
                document.getElementById('editarCelular').value = usuario.celular || '';
                document.getElementById('editarFechaNacimiento').value = usuario.fecha_nacimiento ? usuario.fecha_nacimiento.split('T')[0] : '';
                new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
            }
        }
        if (btnEliminar) {
            const id = btnEliminar.getAttribute('data-id');
            usuarioAEliminar = id;
            new bootstrap.Modal(document.getElementById('modalEliminarUsuario')).show();
        }
    });
    document.getElementById('btnGuardarCambios').addEventListener('click', function() {
        const id = document.getElementById('editarId').value;
        const data = {
            nombres: document.getElementById('editarNombres').value,
            apellidos: document.getElementById('editarApellidos').value,
            dni: document.getElementById('editarDni').value,
            celular: document.getElementById('editarCelular').value,
            fecha_nacimiento: document.getElementById('editarFechaNacimiento').value
        };
        fetch(`/api/duenos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(resp => {
            if (resp.ok) {
                mostrarAlerta('Usuario actualizado correctamente', 'success');
                cargarUsuarios();
                bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
            } else {
                mostrarAlerta('Error al actualizar usuario', 'danger');
            }
        });
    });
    document.getElementById('btnConfirmarEliminar').addEventListener('click', function() {
        if (!usuarioAEliminar) return;
        fetch(`/api/duenos/${usuarioAEliminar}`, { method: 'DELETE' })
            .then(resp => {
                if (resp.ok) {
                    mostrarAlerta('Usuario eliminado correctamente', 'success');
                    cargarUsuarios();
                    bootstrap.Modal.getInstance(document.getElementById('modalEliminarUsuario')).hide();
                } else {
                    mostrarAlerta('Error al eliminar usuario', 'danger');
                }
            });
    });
});
</script>
</body>
</html> 